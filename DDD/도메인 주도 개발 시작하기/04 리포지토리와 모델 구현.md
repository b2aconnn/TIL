# JPAë¥¼ ì´ìš©í•œ ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„

ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ëŠ” ì• ê·¸ë¦¬ê±°íŠ¸ì™€ ê°™ì€ ë„ë©”ì¸ ì˜ì—­ì— ì†í•˜ê³ , ë¦¬í¬ì§€í† ë¦¬ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ëŠ” ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ì˜ì—­ì— ì†í•œë‹¤.

<p align="center"><img width="700" alt="ìŠ¤í¬ë¦°ìƒ· 2023-06-25 ì˜¤í›„ 11 07 06" src="https://github.com/b2aconnn/TIL/assets/89119477/0d9c4110-d6a8-4e1f-93b3-af7db648231c"></p>

<p align="center">DIP ì ìš©í•  ê²½ìš° êµ¬í˜„ í´ë˜ìŠ¤ëŠ” ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì³ ì˜ì—­ì— ìœ„ì¹˜</p>

<br>

## ë¦¬í¬ì§€í† ë¦¬ ê¸°ë³¸ ê¸°ëŠ¥ êµ¬í˜„

- IDë¥¼ í†µí•œ ì• ê·¸ë¦¬ê±°íŠ¸ ì¡°íšŒ
- ì• ê·¸ë¦¬ê±°íŠ¸ ì €ì¥

<br>

**ë‘ ê¸°ëŠ¥ì„ ì¸í„°í˜ì´ìŠ¤ë¡œ í‘œí˜„**

~~~java
public interface OrderRepository {
    Order findById(OrderNo no);
    void save(Order order);
}
~~~

ì¸í„°í˜ì´ìŠ¤ëŠ” ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ì„ í•œë‹¤. 

ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ì˜ ì´ë¦„ì„ ì§€ì„ ë•ŒëŠ” ë³´í†µ findByí”„ë¡œí¼í‹°ì´ë¦„(í”„ë¡œí¼í‹° ê°’) í˜•ì‹ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.

<br>

**ìœ„ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ JPAì˜ EntityManagerë¡œ êµ¬í˜„í•œ í´ë˜ìŠ¤**

~~~java
@Repository
class JpaOrderRepository implements OrderRepository {
    @PersistenceContext
    private EntityManager entityManager;

    @Override
    public Order findById(OrderNo id) {
        // Idë¥¼ í†µí•´ ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ì¡°íšŒ
        return entityManager.find(Order.class, id);
    }

    @Override
    public void save(Order order) {
        // ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ì €ì¥
        entityManager.persist(order);
    }
}
~~~

<br>

**ì• ê·¸ë¦¬ê±°íŠ¸ì˜ ìˆ˜ì •**

~~~java
public class ChangeOrderService {
    @Transactional
    public void changeShippingInfo(OrderNo no, ShippingInfo newShippingInfo) {
        Optional<Order> orderOpt = orderRepository.findById(no);
        Order order = orderOpt.orElseThrow(() -> new OrderNotFoundException());
        // ì• ê·¸ë¦¬ê±°íŠ¸ ìˆ˜ì •
        order.changeShippingInfo(newShippingInfo);
    }
}
~~~

**ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ìˆ˜ì •í•œ í›„ì— ì €ì¥ì†Œì— ë°˜ì˜í•˜ëŠ” ë©”ì†Œë“œë¥¼ ë”°ë¡œ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ë‹¤.**

JPAë¥¼ ì‚¬ìš©í•˜ë©´ íŠ¸ë™ì­ì…˜ ë²”ìœ„ì—ì„œ ë³€ê²½í•œ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ UPDATE ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ì—¬ DBì— ë°˜ì˜ì„ í•´ì£¼ê¸° ë•Œë¬¸ì´ë‹¤.

<br>

**ì• ê·¸ë¦¬ê±°íŠ¸ ì¡°íšŒ**

~~~java
public interface OrderRepository {
    List<Order> findByOrdererId(String ordererId, int startRow, int size);
}
~~~

JPAì—ì„œ ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ì¡°íšŒí•  ë•ŒëŠ” findByë’¤ì— ì¡°ê±´ ëŒ€ìƒì´ ë˜ëŠ” í”„ë¡œí¼í‹°ëª…ì„ ë¶™ì´ë©´ ëœë‹¤.

ë˜ JPAì˜ Criteriaë‚˜ JPQL, queryDSL ë“±ìœ¼ë¡œ ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.

<br>

**ì• ê·¸ë¦¬ê±°íŠ¸ ì‚­ì œ**

~~~java
public interface OrderRepository {
    public void delete(Order order);
}
~~~

ì‚­ì œí•  ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•˜ë©´ ëœë‹¤.

â—ï¸ë³´í†µì€ ì‹¤ì œë¡œ ë¬¼ë¦¬ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì‚­ì œ(hardDelete)í•˜ì§€ ì•ŠëŠ”ë‹¤. ë°ì´í„° ì›ë³µì´ë‚˜ ì¼ì • ê¸°ê°„ ë™ì•ˆ ë°ì´í„°ë¥¼ ë³´ê´€í•´ì•¼ í•  ë•Œë„ ìˆê¸° ë•Œë¬¸ì— ë³´í†µì€ ë…¼ë¦¬ì ì¸ ì‚­ì œ(softDelete)ë¥¼ í†µí•´ ê´€ë¦¬ë¥¼ í•œë‹¤.

<br>

# ë§¤í•‘ êµ¬í˜„

## ì—”í‹°í‹°ì™€ ë°¸ë¥˜ ê¸°ë³¸ ë§¤í•‘ êµ¬í˜„

**ì• ê·¸ë¦¬ê±°íŠ¸ì™€ JPA ë§¤í•‘ì„ ìœ„í•œ ê¸°ë³¸ ê·œì¹™**

- ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ëŠ” ì—”í‹°í‹°ì´ë¯€ë¡œ @Entityë¡œ ë§¤í•‘ ì„¤ì •

**í•œ í…Œì´ë¸”ì— ì—”í‹°í‹°ì™€ ë°¸ë¥˜ê°€ ê°™ì´ ìˆë‹¤ë©´?**

- ë°¸ë¥˜ëŠ” @Embeddableë¡œ ë§¤í•‘ ì„¤ì •
- ë°¸ë¥˜ íƒ€ì… í”„ë¡œí¼í‹°ëŠ” @Embeddedë¡œ ë§¤í•‘ ì„¤ì •

<br>

ğŸ‘‰ ì£¼ë¬¸ ì• ê·¸ë¦¬ê±°íŠ¸ì˜ ì˜ˆ

- ë£¨íŠ¸ ì—”í‹°í‹° : Order
- ë°¸ë¥˜ : Orderer, ShippingInfo, Address, Receiver

<p align="center"><img width="700" alt="ìŠ¤í¬ë¦°ìƒ· 2023-07-10 ì˜¤í›„ 11 54 43" src="https://github.com/b2aconnn/TIL/assets/89119477/1e7c3455-ca80-4181-84cc-81a18a84b22e"></p>

<br>

### JPAì™€ ë§¤í•‘

ë£¨íŠ¸ ì—”í‹°í‹°ì¸ OrderëŠ” JPAì˜ @Entityë¡œ ë§¤í•‘

~~~java
@Entity
@Table(name = "purchase_order")
public class Order {
    // ...
}
~~~

<br>

Orderì— ì†í•˜ëŠ” OrdererëŠ” ë°¸ë¥˜ì´ë¯€ë¡œ @Embeddableë¡œ ë§¤í•‘

~~~java
@Embeddable
public class Orderer {
    // MemberIdì— ì •ì˜ëœ ì»¬ëŸ¼ ì´ë¦„ì„ ë³€ê²½í•˜ê¸° ìœ„í•´ @AttributeOverride ì‚¬ìš©
    @Embedded
    @AttributeOverrides(
        @AttributeOverride(name = "id", column = @Column(name = "orderer_id"))
    )
    private MemberId memberId;

    @Column(name = "orderer_name")
    private String name;
}

@Embeddable
public class MemberId implements Serializable {
    @Column(name = "member_id")
    private String id;
}
~~~

<br>

ë£¨íŠ¸ ì—”í‹°í‹° Order í´ë˜ìŠ¤ëŠ” @Embeddedë¥¼ ì„ ì–¸í•´ ë°¸ë¥˜ íƒ€ì… í”„ë¡œí¼í‹°ë¥¼ ì„¤ì •

~~~java
@Entity
public class Order {
    @Embedded
    private Orderer orderer;
    @Embedded
    private ShippingInfo shippingInfo;
}
~~~

<br>

## ê¸°ë³¸ ìƒì„±ì

**ReceiverëŠ” ë°¸ë¥˜ì´ê³ , ë¶ˆë³€ íƒ€ì…ìœ¼ë¡œ ë§Œë“¤ë ¤ë©´ ìƒì„± ì‹œì ì— í•„ìš”í•œ ê°’ë“¤ì„ ìƒì„±ìë¥¼ í†µí•´ ëª¨ë‘ ì „ë‹¬ ë°›ìœ¼ë¯€ë¡œ set ë©”ì„œë“œë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤. ì¦‰, ê¸°ë³¸ ìƒì„±ìëŠ” í•„ìš” ì—†ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸**í•œë‹¤.

<br>

â—ï¸í•˜ì§€ë§Œ JPAì—ì„œ @Entityì™€ @Embeddableë¡œ í´ë˜ìŠ¤ë¥¼ ë§¤í•‘í•˜ë ¤ë©´ ê¸°ë³¸ ìƒì„±ìê°€ í•„ìš”í•¨

- DBì—ì„œ ë°ì´í„°ë¥¼ ì½ì–´ì™€ì„œ ë§¤í•‘ëœ ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ ê¸°ë³¸ ìƒì„±ìë¥¼ ì‚¬ìš©í•´ì„œ ê°ì²´ë¥¼ ìƒì„±í•˜ê¸° ë•Œë¬¸

<br>

ì´ëŸ° ê¸°ìˆ ì ì¸ ì œì•½ìœ¼ë¡œ ì¸í•´ Receiverì™€ ê°™ì€ ë¶ˆë³€ íƒ•ë¹„ì€ ê¸°ë³¸ ìƒì„±ìê°€ í•„ìš” ì—†ìŒì—ë„ ê¸°ë³¸ ìƒì„±ìë¥¼ ì¶”ê°€í•´ì•¼ í•œë‹¤. ğŸ˜¢

~~~java
@Embeddable
public class Receiver {
    @Column(name = "receiver_name")
    private String name;
    @Column(name = "receiver_phone")
    private String phone;

    protected Receiver() {} // JPAë¥¼ ì ìš©í•˜ê¸° ìœ„í•œ ê¸°ë³¸ ìƒì„±ì ì¶”ê°€

    public Receiver(String name, String phone) {
        this.name = name;
        this.phone = phone;
    }
}
~~~

**ê¸°ë³¸ ìƒì„±ìëŠ” JPA Providerê°€ ê°ì²´ë¥¼ ìƒì„±í•  ë•Œë§Œ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ ì½”ë“œì—ì„œëŠ” ê¸°ë³¸ ìƒì„±ìë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•˜ë„ë¡ protected ì ‘ê·¼ ì œí•œìë¥¼ í†µí•´ ì œí•œí•œë‹¤.**

<br>

## í•„ë“œ ì ‘ê·¼ ë°©ì‹ ì‚¬ìš©

JPAëŠ” í•„ë“œì™€ ë©”ì„œë“œ ë‘ ê°€ì§€ ë°©ì‹ìœ¼ë¡œ ë§¤í•‘ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

- ë©”ì„œë“œ ë°©ì‹ : í”„ë¡œí¼í‹°ë¥¼ ìœ„í•œ get/set ë©”ì„œë“œë¥¼ êµ¬í˜„

~~~java
@Entity
@Access(AccessType.PROPERTY)
public class Order {
    @Column(name = "state")
    @Enumerated(EnumType.STRING)
    public OrderState getState() {
        return state;
    }
    
    public setState(OrderState state) {
        this.state = state;
    }
}
~~~

â—ï¸ ìœ„ì™€ ê°™ì´ ë©”ì„œë“œ ë°©ì‹ì„ í†µí•´ í”„ë¡œí¼í‹°ë¥¼ ìœ„í•œ set ë©”ì„œë“œë¥¼ ë§Œë“¤ê²Œ ë˜ë©´ ë‚´ë¶€ ë°ì´í„°ë¥¼ ì™¸ë¶€ì—ì„œ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ê°€ëŠ¥ì„±ì„ ì—´ì–´ë‘ê¸° ë•Œë¬¸ì— ìº¡ìŠí™”ë¥¼ ê¹¨ëŠ” ì›ì¸ì´ ë˜ì–´ ê°ì²´ë¡œì„œ ì œ ì—­í• ì„ í•˜ì§€ ëª» í•  ìˆ˜ ìˆë‹¤.

<br>

- í•„ë“œ ë°©ì‹

~~~java
@Entity
@Access(AccessType.FIELD)
public class Order {
    @EmbeddedId
    private OrderNo number;

    @Column(name = "state")
    @Enumerated(EnumType.STRING)
    private OrderState state;
    
    public void cancel() { // ëª…í™•í•œ ì˜ë„ë¡œ ë„ë©”ì¸ ê¸°ëŠ¥ êµ¬í˜„
        // ...
    }
}
~~~

set ë©”ì„œë“œ ëŒ€ì‹  ëª…í™•í•œ ì˜ë„ê°€ ë“œëŸ¬ë‚˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•˜ë¯€ë¡œì¨ ë„ë©”ì¸ì„ ë” ì˜ í‘œí˜„í•  ìˆ˜ ìˆë‹¤.

<br>

## AttributeConverterë¥¼ ì´ìš©í•œ ë°¸ë¥˜ ë§¤í•‘ ì²˜ë¦¬

Integer, String LocalDateTimeê³¼ ê°™ì€ íƒ€ì…ì€ DB í…Œì´ë¸”ì˜ í•œ ê°œì˜ ì»¬ëŸ¼ì— ë§¤í•‘ë˜ì–´ì„œ ì €ì¥ì´ ê°€ëŠ¥í•˜ë‹¤.

ë°¸ë¥˜ íƒ€ì…ì˜ í”„ë¡œí¼í‹°ë¥¼ í•œ ê°œ ì»¬ëŸ¼ì— ë§¤í•‘í•´ì•¼ í•  ë•Œì—ëŠ” @Embeddableë¡œ ì²˜ë¦¬í•  ìˆ˜ ì—†ë‹¤.

<p align="center"><img width="600" alt="ìŠ¤í¬ë¦°ìƒ· 2023-07-12 ì˜¤í›„ 9 16 00" src="https://github.com/b2aconnn/TIL/assets/89119477/c2f83622-d96f-4390-891f-88b2e9470a15"></p>

ğŸ‘‰ **ë°¸ë¥˜ íƒ€ì…ì˜ ë‘ ê°œ ì´ìƒì˜ í”„ë¡œí¼í‹°ë¥¼ í•œ ê°œì˜ ì»¬ëŸ¼ìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ AttributeConverterê°€ ìˆë‹¤.**

~~~java
public interface AttributeConverter<X, Y> { // X: ë°¸ë¥˜ íƒ€ì…, Y: DB íƒ€ì…
    public Y convertToDatabaseColumn(X attribute); // ë°¸ë¥˜ íƒ€ì… -> DB ì»¬ëŸ¼ ê°’ìœ¼ë¡œ ë³€í™˜
    public X convertToEntityAttribute(Y dbData); // DB ì»¬ëŸ¼ ê°’ -> ë°¸ë¥˜ íƒ€ì… ê°’ìœ¼ë¡œ ë³€í™˜
}
~~~

<br>

**Money ë°¸ë¥˜ íƒ€ì…ì„ ìœ„í•œ AttributeConverter êµ¬í˜„**

~~~java
@Converter(autoApply = true)
public class MoneyConverter implements AttributeConverter<Money, Integer> {
    @Override
    public Integer convertToDatabaseColumn(Money money) {
        return money == null ? null : money.getValue();
    }
    
    @Override
    public Money convertToEntityAttribute(Integer value) {
        return value == null ? null : new Money(value);
    }
}
~~~

- AttributeConverterì˜ êµ¬í˜„ í´ë˜ìŠ¤ëŠ” @Converter ì ìš©í•´ì•¼ í•¨
- autoApply ì†ì„±ì˜ ê°’ìœ¼ë¡œ trueë¥¼ ì§€ì •í•˜ë©´ Money íƒ€ì…ì˜ í”„ë¡œí¼í‹°ì— ëŒ€í•´ MoneyConverterë¥¼ ìë™ìœ¼ë¡œ ì ìš©

<br>

**MoneyConverterê°€ ì ìš©ëœ Order Entity**

~~~java
@Entity
@Table(name = "purchase_order")
public class Order {
    // ...
    
    @Column(name = "total_amounts")
    private Money totalAmounts; // MoneyConverterë¥¼ ì ìš©í•´ì„œ ê°’ ë³€í™˜
}
~~~

<br>

**autoApply = falseì¼ ê²½ìš° ì§ì ‘ ì»¨ë²„í„° ì§€ì •**

~~~java
public class Order {
    @Column(name = "total_amounts")
    @Convert(converter = MoneyConverter.class)
    private Money totalAmounts;
}
~~~

<br>

## ë°¸ë¥˜ ì»¬ë ‰ì…˜: ë³„ë„ í…Œì´ë¸” ë§¤í•‘

Order EntityëŠ” í•œ ê°œ ì´ìƒì˜ OrderLineì„ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.

<br>

**ìˆœì„œë¥¼ ê°€ì§€ëŠ” OrderLineì„ í¬í•¨í•œ Order Entity**

~~~java
public class Order {
    private List<OrderLine> orderLines;
    // ...
}
~~~

<br>

ë°¸ë¥˜ ì»¬ë ‰ì…˜ì¸ **`List<OrderLine>`** ì„ ë³„ë„ í…Œì´ë¸”ë¡œ ë§¤í•‘í•  ë•ŒëŠ” **`@ElementCollection`** ê³¼ **`@CollectionTable`**ì„ í•¨ê»˜ ì‚¬ìš©

~~~java
@Entity
@Table(name = "purchase_order")
public class Order {
    @EmbeddedId
    private OrderNo number;

    @ElementCollection(fetch = FetchType.EAGER)
    @CollectionTable(name = "order_line",
               joinColumns = @JoinColumn(name = "order_number"))
    @OrderColumn(name = "line_idx")
    private List<OrderLine> orderLines;
    
    // ...
}

@Embeddable
public class OrderLine {
    @Embedded
    private ProductId productId;
    
    @Column(name = "price")
    private Money price;
    
    @Column(name = "quantity")
    private int quantity;
    
    @Column(name = "amounts")
    private Money amounts;
}
~~~

- @OrderColumn : ì§€ì •í•œ ì»¬ëŸ¼ì— ë¦¬ìŠ¤íŠ¸ì˜ ì¸ë±ìŠ¤ ê°’ì„ ì €ì¥
  - line_idxë¼ëŠ” DB ì»¬ëŸ¼ì— ì¸ë±ìŠ¤ê°€ ì €ì¥ë¨
- @CollectionTable : ë°¸ë¥˜ë¥¼ ì €ì¥í•  í…Œì´ë¸”ì„ ì§€ì •
  - name ì†ì„± : í…Œì´ë¸” ì´ë¦„ ì§€ì •
  - joinColumns ì†ì„± : ì™¸ë¶€í‚¤ë¡œ ì‚¬ìš©í•  ì»¬ëŸ¼ ì§€ì •

<br>

## ë°¸ë¥˜ ì»¬ë ‰ì…˜: í•œê°œ ì»¬ëŸ¼ ë§¤í•‘

ë°¸ë¥˜ ì»¬ë ‰ì…˜ì„ ë³„ë„ í…Œì´ë¸”ì´ ì•„ë‹Œ **í•œ ê°œ ì»¬ëŸ¼ì— ì €ì¥í•´ì•¼ í•  ë•Œ AttributeConverterë¥¼ ì‚¬ìš©í•˜ì—¬ ë§¤í•‘í•  ìˆ˜ ìˆë‹¤.**

AttributeConverterë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë°¸ë¥˜ ì»¬ë ‰ì…˜ì„ í‘œí˜„í•˜ëŠ” ë°¸ë¥˜ íƒ€ì…ì„ í•˜ë‚˜ ì¶”ê°€í•´ì•¼ í•œë‹¤.

<br>

**Email ì£¼ì†Œ ëª©ë¡ì˜ ë°¸ë¥˜ íƒ€ì… í´ë˜ìŠ¤**

~~~java
public class EmailSet {
    private Set<Email> emails = new HashSet<>(); // ë°¸ë¥˜ ì»¬ë ‰ì…˜

    public EmailSet(Set<Email> emails) {
        this.emails.addAll(emails);
    }

    public Set<Email> getEmails() {
        return Collections.unmodifiableSet(emails);
    }
}
~~~

<br>

**AttributeConverter êµ¬í˜„**

~~~java
public class EmailSetConverter implements AttributeConverter<EmailSet, String> {
    @Override
    public String convertToDatabaseColumn(EmailSet attribute) {
        // ...
    }

    @Override
    public EmailSet convertToEntityAttribute(String dbData) {
        // ...
    }
}
~~~

<br>

**Converter ì§€ì •**

~~~java
@Column(name = "emails")
@Convert(converter = EmailSetConverter.class)
private EmailSet emailSet;
~~~

<br>

## ë°¸ë¥˜ë¥¼ ì´ìš©í•œ ID ë§¤í•‘

ë°¸ë¥˜ íƒ€ì…ì„ ì‹ë³„ìë¡œ ë§¤í•‘í•˜ë ¤ë©´ @Idê°€ ì•„ë‹Œ @EmbeddedIdë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

~~~java
@Embeddable
public class OrderNo implements Serializable {
    @Column(name = "order_number")
    private String number;
    
    public boolean is2ndGeneration() {
        return number.startsWith("N");
    }
}
~~~

ğŸ’â€â™‚ï¸ **ë°¸ë¥˜ íƒ€ì…ìœ¼ë¡œ ì‹ë³„ìë¥¼ êµ¬í˜„í•  ë•Œ ì–»ì„ ìˆ˜ ìˆëŠ” ì¥ì ì€ ì‹ë³„ìì— ê¸°ëŠ¥ì„ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤ëŠ” ì ì´ë‹¤.**

- 1ì„¸ëŒ€ ì‹œìŠ¤í…œ ì£¼ë¬¸ ë²ˆí˜¸ì™€ 2ì„¸ëŒ€ ì‹œìŠ¤í…œì˜ ì£¼ë¬¸ ë²ˆí˜¸ë¥¼ êµ¬ë¶„í•  ë•Œ ì²« ê¸€ìë¥¼ ì´ìš©í•  ê²½ìš°, is2ndGeneration() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ì„œ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

ğŸ‘‰ JPAëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ì—”í‹°í‹°ë¥¼ ë¹„êµí•  ëª©ì ìœ¼ë¡œ equals()ì™€ hashcode() ê°’ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ì‹ë³„ìë¡œ ë°¸ë¥˜ íƒ€ì…ì„ ì‚¬ìš©í•  ê²½ìš° ë‘ ë©”ì„œë“œë¥¼ ì•Œë§ê²Œ êµ¬í˜„í•´ì•¼ í•œë‹¤.

<br>

## ë³„ë„ í…Œì´ë¸”ì— ì €ì¥í•˜ëŠ” ë°¸ë¥˜ ë§¤í•‘

ì• ê·¸ë¦¬ê±°íŠ¸ì—ì„œ ë£¨íŠ¸ ì—”í‹°í‹°ë¥¼ ì œì™¸í•œ êµ¬ì„±ìš”ì†ŒëŠ” ëŒ€ë¶€ë¶„ ë°¸ë¥˜ì´ë‹¤.

<br>

ğŸ’â€â™‚ï¸ **ë°¸ë¥˜ì¸ ì§€ ì—”í‹°í‹°ì¸ ì§€ êµ¬ë¶„í•˜ëŠ” ë°©ë²•ì€ ê³ ìœ  ì‹ë³„ìë¥¼ ê°–ëŠ” ì§€ì˜ ì—¬ë¶€ì— ë”°ë¼ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤.**

- ë³„ë„ í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ ì €ì¥í•œë‹¤ê³  í•´ì„œ ì—”í‹°í‹°ì¸ ê²ƒì€ ì•„ë‹ˆë‹¤.
- ì‹ë³„ìë¥¼ ì°¾ì„ ë•Œ ë§¤í•‘ë˜ëŠ” í…Œì´ë¸”ì˜ ì‹ë³„ìë¥¼ ì• ê·¸ë¦¬ê±°íŠ¸ êµ¬ì„±ìš”ì†Œì˜ ì‹ë³„ìì™€ ë™ì¼í•œ ê²ƒìœ¼ë¡œ ì°©ê°í•´ì„  ì•ˆëœë‹¤.
  - ë³„ë„ í…Œì´ë¸”ë¡œ ì €ì¥í•˜ê³  í…Œì´ë¸”ì— PKê°€ ìˆë‹¤ê³  í•´ì„œ í…Œì´ë¸”ê³¼ ë§¤í•‘ë˜ëŠ” ì• ê·¸ë¦¬ê±°íŠ¸ êµ¬ì„±ìš”ì†Œê°€ í•­ìƒ ê³ ìœ  ì‹ë³„ìë¥¼ ê°–ëŠ” ê²ƒì€ ì•„ë‹ˆê¸° ë•Œë¬¸

<br>

<p align="center"><img width="500" alt="ìŠ¤í¬ë¦°ìƒ· 2023-07-14 ì˜¤ì „ 12 13 31" src="https://github.com/b2aconnn/TIL/assets/89119477/354ab74d-d82f-4120-bbc7-f4a29da6e7eb"></p>

<p align="center">ë°¸ë¥˜ë¥¼ ì—”í‹°í‹°ë¡œ ì˜ëª» ë§¤í•‘í•œ ì˜ˆ</p>

<br>

ARTICLE í…Œì´ë¸”ê³¼ ARTICLE_CONTENT í…Œì´ë¸”ì˜ 1:1 ê´€ê³„ì´ë‹¤. 

ARTICLE_CONTENT í…Œì´ë¸”ì— ìˆëŠ” **ID ê°’ì´ ì‹ë³„ì ì—­í• ë„ ê°€ëŠ¥ì€ í•˜ì§€ë§Œ ARTICLE í…Œì´ë¸”ê³¼ ì—°ê´€ê´€ê³„ë¥¼ ê°–ê¸° ìœ„í•¨ì´ê¸° ë•Œë¬¸ì— ì—”í‹°í‹°ë¡œ  íŒë‹¨í•˜ê¸°ë³´ë‹¨ ë°¸ë¥˜ë¡œ íŒë‹¨í•˜ëŠ” ê²ƒì´ ë” ì˜¬ë°”ë¥¸ ì„¤ê³„ì¼ ìˆ˜ ìˆë‹¤.**

ê·¸ë ‡ê¸° ë•Œë¬¸ì— ê²Œì‹œê¸€ì˜ íŠ¹ì • í”„ë¡œí¼í‹°ë¥¼ ë³„ë„ í…Œì´ë¸”ì— ë³´ê´€í•˜ëŠ” ê²ƒìœ¼ë¡œ ì ‘ê·¼í•´ì•¼ í•œë‹¤.

<br>

<p align="center"><img width="500" alt="ìŠ¤í¬ë¦°ìƒ· 2023-07-14 ì˜¤ì „ 12 26 48" src="https://github.com/b2aconnn/TIL/assets/89119477/8ab4ae89-9c62-4a62-b95c-2b0ed3e92b82"></p>

<p align="center">ë³„ë„ í…Œì´ë¸”ë¡œ ë°¸ë¥˜ë¥¼ ë§¤í•‘í•œ ëª¨ë¸</p>

<br>

**@SecondaryTableì„ ì´ìš©í•œ ë°¸ë¥˜ ë§¤í•‘ ì„¤ì •**

~~~java
@Entity
@Table(name ="atricle")
@SecondaryTable(
        name = "article_content",
        pkJoinColumns = @PrimaryKeyJoinColumn(name = "id")
)
public class Article {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String title;

    @AttributeOverrides({
            @AttributeOverride(
                    name = "content",
                    column = @Column(table = "article_content", name = "content")),
            @AttributeOverride(
                    name = "contentType",
                    column = @Column(table = "article_content", name = "content_type"))
    })
    @Embedded
    private ArticleContent content;
}
~~~

- ArticleContentëŠ” ë°¸ë¥˜ì´ë¯€ë¡œ @Embeedableë¡œ ë§¤í•‘

- @SecondaryTable, @AttributeOverride : ë°¸ë¥˜ë¥¼ ë§¤í•‘í•œ í…Œì´ë¸”ì„ ì§€ì •

  - @SecondaryTable

    - name ì†ì„± : ë°¸ë¥˜ë¥¼ ì €ì¥í•  í…Œì´ë¸”ì„ ì§€ì •

    - pkJoinColumns ì†ì„± : ë°¸ë¥˜ í…Œì´ë¸”ì—ì„œ ì—”í‹°í‹° í…Œì´ë¸”ë¡œ ì¡°ì¸í•  ë•Œ ì‚¬ìš©í•  ì»¬ëŸ¼ ì§€ì •

<br>

ğŸ‘‰ **@SecondaryTableì„ ì´ìš©í•˜ë©´ Article ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œ ArticleContentë„ ê°™ì´ ì¡°íšŒëœë‹¤.**

~~~java
@SecondaryTableë¡œ ë§¤í•‘ëœ article_content í…Œì´ë¸”ì„ ì¡°ì¸
Article article = entityManager.find(Article.class, 1L);
~~~

- article í…Œì´ë¸”ì˜ ë°ì´í„°ë§Œ í•„ìš”í•  ë•Œ ë¶ˆí•„ìš”í•˜ê²Œ article_content í…Œì´ë¸”ì˜ ë°ì´í„°ê¹Œì§€ ì¡°íšŒëœë‹¤.

ì§€ì—° ë¡œë”© ë°©ì‹ì„ ì„¤ì •í•´ì„œ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì§€ë§Œ í•˜ì§€ë§Œ ë°¸ë¥˜ ëª¨ë¸ì„ ì—”í‹°í‹°ë¡œ ë§Œë“¤ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ì¢‹ì€ ë°©ë²•ì€ ì•„ë‹ˆë‹¤. ğŸ˜¢

<br>

ğŸ’¡ **ìœ„ì™€ ê°™ì€ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì§€ì—° ë¡œë”© ëŒ€ì‹  ì¡°íšŒ ì „ìš© ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.**

<br>

## ë°¸ë¥˜ ì»¬ë ‰ì…˜ì„ @Entityë¡œ ë§¤í•‘í•˜ê¸°

ë°¸ë¥˜ë¥¼ êµ¬í˜„ ê¸°ìˆ  í•œê³„ ë˜ëŠ” íŒ€ í‘œì¤€ ë“±ì˜ ì œí•œëœ ì´ìœ ë¡œ @Entityë¥¼ ì‚¬ìš©í•´ì•¼í•  ë•Œë„ ìˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ ì œí’ˆì˜ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë°©ì‹ì— ë”°ë¼ ì´ë¯¸ì§€ ê²½ë¡œì™€ ì„¬ë„¤ì¼ ì´ë¯¸ì§€ ì œê³µ ì—¬ë¶€ê°€ ë‹¬ë¼ì§ˆ ê²½ìš°ê°€ ìˆì„ ìˆ˜ ìˆë‹¤.

ì´ ê²½ìš° ì•„ë˜ì™€ ê°™ì€ ê³„ì¸µ êµ¬ì¡°ë¥¼ ì„¤ê³„í•  ìˆ˜ ìˆë‹¤.

<br>

<p align="center"><img width="500" alt="ìŠ¤í¬ë¦°ìƒ· 2023-07-16 ì˜¤í›„ 4 16 16" src="https://github.com/b2aconnn/TIL/assets/89119477/a1e99e4d-47ac-4f70-a79b-2345e6d2b02e"></p>

<p align="center">ê³„ì¸µ êµ¬ì¡°ë¥¼ ê°–ëŠ” ë°¸ë¥˜ íƒ€ì…</p>

<br>

ğŸ’â€â™‚ï¸ **JPAëŠ” @Embeddable íƒ€ì…ì˜ í´ë˜ìŠ¤ ìƒì† ë§¤í•‘ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤.**

- ImageëŠ” ë°¸ë¥˜ì´ë‹¤. **ìƒì† êµ¬ì¡°ë¥¼ ê°–ëŠ” ë°¸ë¥˜ íƒ€ì…ì„ ì‚¬ìš©í•˜ë ¤ë©´ @Embeddable ëŒ€ì‹  @Entityë¥¼ ì´ìš©í•´ì„œ ìƒì† ë§¤í•‘ì„ ì²˜ë¦¬í•´ì•¼ í•œë‹¤.**

- @Entityë¡œ ë§¤í•‘í•  ê²½ìš°, ì‹ë³„ì ë§¤í•‘ì„ ìœ„í•œ í•„ë“œë„ ì¶”ê°€í•´ì•¼ í•œë‹¤.
- êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ êµ¬ë¶„í•˜ê¸° ìœ„í•œ íƒ€ì… ì‹ë³„(discriminator) ì¹¼ëŸ¼ë„ ì¶”ê°€í•´ì•¼ í•œë‹¤.

<br>

<p align="center">
  <img width="500" alt="ìŠ¤í¬ë¦°ìƒ· 2023-07-16 ì˜¤í›„ 4 50 14" src="https://github.com/b2aconnn/TIL/assets/89119477/30bca672-6414-4e13-8dce-526198db9031">
</p>

<p align="center">Image ê³„ì¸µ êµ¬ì¡°ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ IMAGE í…Œì´ë¸”</p>

<br>

ğŸ‘‰ í•œ í…Œì´ë¸”ì— Imageì™€ ê·¸ í•˜ìœ„ í´ë˜ìŠ¤ë¥¼ ë§¤í•‘í•˜ë¯€ë¡œ Image í´ë˜ìŠ¤ì— ë‹¤ìŒ ì„¤ì •ì„ ì‚¬ìš©í•œë‹¤.

- @Inheritance ì ìš©
- strategy ê°’ìœ¼ë¡œ SINGLE_TABLE ì‚¬ìš©
- @DiscriminatorColumnì„ ì´ìš©í•˜ì—¬ íƒ€ì… êµ¬ë¶„ìš©ìœ¼ë¡œ ì‚¬ìš©í•  ì»¬ëŸ¼ ì§€ì •

<br>

**Imageë¥¼ @Entityë¡œ ë§¤í•‘í–ˆì§€ë§Œ ëª¨ë¸ì—ì„œ ImageëŠ” ë°¸ë¥˜ì´ë¯€ë¡œ ìƒíƒœ ë³€ê²½í•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤.**

~~~java
@Entity
@Inheritance(strategy = InheritanceType.SINGLE_TABLE)
@DiscriminatorColumn(name = "image_type")
@Table(name = "image")
public abstract class Image {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "image_id")
    private Long id;

    @Column(name = "image_path")
    private String path;

    @Temporal(TemporalType.TIMESTAMP)
    @Column(name = "upload_time")
    private Date uploadTime;

    protected Image() {}
    public Image(String path) {
        this.path = path;
        this.uploadTime = new Date();
    }

    protected String getPath() {
        return path;
    }

    public Date getUploadTime() {
        return uploadTime;
    }
    
    // ìƒíƒœ ë³€ê²½ ë©”ì„œë“œ ì œê³µ X

    public abstract String getURL();
    public abstract boolean hasThumbnail();
    public abstract String getThumbnailURL();
}
~~~

<br>

Imageë¥¼ ìƒì†ë°›ì€ í´ë˜ìŠ¤ëŠ” @Entityì™€ @Discriminatorë¥¼ ì‚¬ìš©í•´ì„œ ë§¤í•‘ ì„¤ì •í•œë‹¤.

~~~java
@Entity
@DiscriminatorValue("II")
public class InternalImage extends Image {
    // ...
}

@Entity
@DiscriminatorValue("EI")
public class ExternalImage extends Image {
    // ...
}
~~~

<br>

ImageëŠ” ë°¸ë¥˜ì´ë¯€ë¡œ ë…ìì ì¸ ë¼ì´í”„ ì‚¬ì´í´ì„ ê°–ì§€ ì•Šê³  Productì— ì™„ì „íˆ ì˜ì¡´í•œë‹¤.

~~~java
@Entity
@Table(name = "product")
public class Product {
    @EmbeddedId
    private ProductId id;
    private String name;

    @Convert(converter = MoneyConverter.class)
    private Money price;
    private String detail;

    @OneToMany(
            cascade = { Cascade.PERSIST, Cascade.REMOVE },
            orphanRemoval = true)
    @JoinColumn(name = "product_id")
    @OrderColumn(name = "list_idx")
    private List<Image> images = new ArrayList<>();

    // ..
    public void changeImages(List<Image> newImages) {
        images.clear();
        images.addAll(newImages);
    }
}
~~~

- Product ì €ì¥ë  ë•Œ ê°™ì´ ì €ì¥ë˜ê³ , ì‚­ì œë  ë•Œ ê°™ì´ ì‚­ì œë˜ë„ë¡ í•˜ê¸° ìœ„í•´ cascase ì†ì„±ì„ ì§€ì •
- Image ê°ì²´ë¥¼ ì œê±°í•˜ë©´ DBì—ì„œ í•¨ê»˜ ì‚­ì œê°€ ë˜ë„ë¡ orphanRemoval = true ì„¤ì •

<br>

â—ï¸ **changeImages() ì—ì„œ ì´ë¯¸ì§€ êµì²´ë¥¼ ìœ„í•´ clear() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ëŠ”ë° @Entityì— ëŒ€í•œ @OneToMany ë§¤í•‘ì—ì„œ ì»¬ë ‰ì…˜ì˜ clear()ë¥¼ í˜¸ì¶œí•˜ë©´ ì‚­ì œ ê³¼ì •ì´ íš¨ìœ¨ì ì´ì§€ ì•Šë‹¤.** ğŸ˜¢

- í•˜ì´ë²„ë„¤ì´íŠ¸ì˜ ê²½ìš° @Entityë¥¼ ìœ„í•œ ì»¬ë ‰ì…˜ ê°ì²´ì˜ clear() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ select ì¿¼ë¦¬ë¡œ ëŒ€ìƒ ì—”í‹°í‹°ë¥¼ ë¡œë”©í•˜ê³ , ê° ê°œë³„ ì—”í‹°í‹°ì— ëŒ€í•´ delete ì¿¼ë¦¬ë¥¼ ì‹¤í–‰
  - ì¦‰ imagesì— ë³´ê´€ë˜ì–´ ìˆë˜ **Image ê°œìˆ˜ê°€ 4ê°œë©´ select ì¿¼ë¦¬ 1ë²ˆ, Image ì‚­ì œë¥¼ ìœ„í•œ delete ì¿¼ë¦¬ 4ë²ˆ ë¹„ìš©ì´ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ë³€ê²½ ë¹ˆë„ê°€ ë†’ìœ¼ë©´ ì „ì²´ ì„œë¹„ìŠ¤ ì„±ëŠ¥ì— ë¬¸ì œê°€ ë  ìˆ˜ ìˆìŒ**

<br>

ğŸ¤” **ì• ê·¸ë¦¬ê±°íŠ¸ì˜ íŠ¹ì„±ì„ ìœ ì§€í•˜ë©´ì„œ ìœ„ì™€ ê°™ì€ ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´ ìƒì†ì„ í¬ê¸°í•˜ê³  @Embeddableë¡œ ë§¤í•‘ëœ ë‹¨ì¼ í´ë˜ìŠ¤ë¡œ êµ¬í˜„í•´ì•¼í•œë‹¤.**

- í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” **@Embeddable íƒ€ì…ì— ëŒ€í•œ ì»¬ë ‰ì…˜ì˜ clear() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ì»¬ë ‰ì…˜ì— ì†í•œ ê°ì²´ë¥¼ ë¡œë”©í•˜ì§€ ì•Šê³  í•œ ë²ˆì˜ deleteì¿¼ë¦¬ë¡œ ì‚­ì œ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰**í•œë‹¤.

<br>

~~~java
@Embeddable
public class Image {
    @Column(name = "image_type")
    private String iamgeType;
    @Column(name = "image_path")
    private String path;

    @Temporal(TemporalType.TIMESTAMP)
    @Column(name = "upload_time")
    private Date uploadTime;

    // ..

    public boolean hasThumbnail() {
        // ì„±ëŠ¥ì„ ìœ„í•´ ë‹¤í˜•ì„ í¬ê¸°í•˜ê³  if-elseë¡œ êµ¬í˜„
        if (iamgeType.equals("II")) {
            return true;
        } else {
            return false;
        }
    }
}
~~~

íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ if-elseë¥¼ ì‚¬ìš©

<br>

## ID ì°¸ì¡°ì™€ ì¡°ì¸ í…Œì´ë¸”ì„ ì´ìš©í•œ ë‹¨ë°©í–¥ M-N ë§¤í•‘

ì• ê·¸ë¦¬ê±°íŠ¸ ê°„ ì§‘í•© ì—°ê´€ì€ ì„±ëŠ¥ ìƒì˜ ì´ìœ ë¡œ í”¼í•´ì•¼ í•œë‹¤.

ìš”êµ¬ì‚¬í•­ì„ êµ¬í˜„í•˜ëŠ”ë° ì§‘í•© ì—°ê´€ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ìœ ë¦¬í•˜ë‹¤ë©´ ID ì°¸ì¡°ë¥¼ ì´ìš©í•œ ë‹¨ë°©í–¥ ì§‘í•© ì—°ê´€ì„ ì ìš©í•´ë³¼ ìˆ˜ ìˆë‹¤.

~~~java
@Entity
@Table(name = "product")
public class Product {
    @EmbeddedId
    private ProductId id;

    @ElementCollection
    @CollectionTable(name = "product_category",
            joinColumns = @JoinColumn(name = "product_id"))
    private Set<CategoryId> categoryIds;
}
~~~

- ID ì°¸ì¡° ë°©ì‹ìœ¼ë¡œ Productì—ì„œ Categoryë¡œì˜ ë‹¨ë°©í–¥ M-N ì—°ê´€ì„ êµ¬í˜„
- ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ì§ì ‘ ì°¸ì¡°í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í–ˆë‹¤ë©´ ì˜ì†ì„± ì „íŒŒë‚˜ ë¡œë”© ì „ëµì„ ê³ ë¯¼í•´ì•¼ í•˜ì§€ë§Œ ID ì°¸ì¡° ë°©ì‹ì„ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ê³ ë¯¼ì„ ëœ ìˆ˜ ìˆë‹¤.

<br>

# ì• ê·¸ë¦¬ê±°íŠ¸ ë¡œë”© ì „ëµ

ì• ê·¸ë¦¬ê±°íŠ¸ëŠ” ê°œë…ì ìœ¼ë¡œ í•˜ë‚˜ì—¬ì•¼ í•œë‹¤.

ì¡°íšŒ ì‹œì ì—ì„œ ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ì™„ì „í•œ ìƒíƒœê°€ ë˜ë„ë¡ í•˜ë ¤ë©´ ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ì—ì„œ ì—°ê´€ ë§¤í•‘ì˜ ì¡°íšŒ ë°©ì‹ì„ ì¦‰ì‹œ ë¡œë”©(FetchType.EAGER)ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ëœë‹¤.

**ì¦‰ì‹œ ë¡œë”© ë°©ì‹ì„ í†µí•´ ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ë¥¼ ë¡œë”©í•˜ëŠ” ì‹œì ì— ì• ê·¸ë¦¬ê±°íŠ¸ì— ì†í•œ ëª¨ë“  ê°ì²´ë¥¼ í•¨ê»˜ ë¡œë”©**

- ì• ê·¸ë¦¬ê±°íŠ¸ì— ì†í•œ ëª¨ë“  ê°ì²´ê°€ ëª¨ì—¬ ì™„ì „í•œ ìƒíƒœê°€ ë¨

<br>

EntityManager#find() ë©”ì„œë“œë¡œ ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ë¥¼ êµ¬í•  ë•Œ ì—°ê´€ëœ êµ¬ì„±ìš”ì†Œë¥¼ DBì—ì„œ í•¨ê»˜ ì½ì–´ì˜¨ë‹¤.

~~~java
// @Entity ì»¬ë ‰ì…˜ì— ëŒ€í•œ ì¦‰ì‹œ ë¡œë”© ì„¤ì •
@OneToMany(cascade = {CascadeType.PERSIST, CascadeType.REMOVE},
        orphanRemoval = true, fetch = FetchType.EAGER) // ì¦‰ì‹œ ë¡œë”© ì„¤ì •
@JoinColumn(name = "product_id")
@OrderColumn(name = "list_idx")
private List<Image> images = new ArrayList<>();


// @Embeddable ì»¬ë ‰ì…˜ì— ëŒ€í•œ ì¦‰ì‹œ ë¡œë”© ì„¤ì •
@ElementCollection(fetch = FetchType.EAGER) // ì¦‰ì‹œ ë¡œë”© ì„¤ì •
@CollectionTable(name = "order_line"),
        joinColumns = @JoinColumn(name = "order_number")
@OrderColumn(name = "line_idx")
private List<OrderLine> orderLines;
~~~

<br>

â—ï¸**í•˜ì§€ë§Œ ì¦‰ì‹œ ë¡œë”© ë°©ì‹ì„ ì‚¬ìš©í•  ê²½ìš° ì„±ëŠ¥ ì´ìŠˆê°€ ìˆì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ê²€í† í•´ë´ì•¼ í•œë‹¤.**

- ì¡°íšŒë˜ëŠ” ë°ì´í„° ê°œìˆ˜ê°€ ë§ì•„ì§€ë©´ ì„±ëŠ¥ ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆë‹¤.

**Product ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ì— @Entityë¡œ êµ¬í˜„í•œ Imageì™€ @Embeddableë¡œ êµ¬í˜„í•œ Option ëª©ë¡**

~~~java
@Entity
public class Product {
    // ..

    @OneToMany(cascade = {CascadeType.PERSIST, CascadeType.REMOVE},
            orphanRemoval = true,
            fetch = FetchType.EAGER) // ì¦‰ì‹œ ë¡œë”©
    @JoinColumn(name = "product_id")
    @OrderColumn(name = "list_idx")
    private List<Image> images = new ArrayList<>();

    @ElementCollection(fetch = FetchType.EAGER) // ì¦‰ì‹œ ë¡œë”©
    @CollectionTable(name = "product_option"),
        joinColumns = @JoinColumn(name = "product_id")
    @OrderColumn(name = "line_idx")
    private List<Option> options = new ArrayList<>();

    // ..
}
~~~

**ì¦‰ì‹œ ë¡œë”© ë°©ì‹ì„ í†µí•´ Productì„ ì¡°íšŒí•  ë•Œ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬**

~~~sql
select *
from product p
left outer join image img on p.product_id=img.product_id
left outer join product_option opt on p.product_id=opt.product_id
where p.product_id=?
~~~

- ì¹´íƒ€ì‹œì•ˆ(Cartesian) ì¡°ì¸ì„ ì‚¬ìš©í•˜ëŠ” ì¿¼ë¦¬ì´ë©°, **ì¿¼ë¦¬ ê²°ê³¼ëŠ” ì¤‘ë³µì„ ë°œìƒ**ì‹œí‚¨ë‹¤.

- í•˜ì´ë²„ë„¤ì´íŠ¸ê°€ ì¤‘ë³µëœ ë°ì´í„°ë¥¼ ì•Œë§ê²Œ ì œê±°í•´ ì‹¤ì œ ë©”ëª¨ë¦¬ì—ëŠ” ì›í•˜ëŠ” ê°œìˆ˜ì˜ ê°ì²´ë¡œ ë³€í™˜í•´ì£¼ì§€ë§Œ, Imageê°€ 20ê°œ, Optionì´ 15ê°œì¼ ê²½ìš° ì‹¤í–‰í•˜ëŠ” ì¿¼ë¦¬ëŠ” 300í–‰ì„ ë¦¬í„´í•œë‹¤.

  **ì‹¤ì œ í•„ìš”í•œ í–‰ì¸ 34(1(Product) + 20(Image) + 15(Option))ê°œì¸ë° í•„ìš” ì´ìƒì˜ ë§ì€ í–‰ì„ ë¦¬í„´**í•œë‹¤.

<br>

**ğŸ¤” ì• ê·¸ë¦¬ê±°íŠ¸ê°€ ì™„ì „í•´ì•¼ í•˜ëŠ” ì´ìœ ëŠ” ë­˜ê¹Œ?**

- ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” ê¸°ëŠ¥ì„ ì‹¤í–‰í•  ë•Œ ì• ê·¸ë¦¬ê±°íŠ¸ ìƒíƒœê°€ ì™„ì „í•´ì•¼ í•¨
- í‘œí˜„ ì˜ì—­ì—ì„œ ì• ê·¸ë¦¬ê±°íŠ¸ì˜ ìƒíƒœ ì •ë³´ë¥¼ ë³´ì—¬ì¤„ ë•Œ í•„ìš”

<br>

ğŸ‘‰ ì• ê·¸ë¦¬ê±°íŠ¸ì˜ ìƒíƒœ ì •ë³´ëŠ” ë³„ë„ì˜ ì¡°íšŒ ì „ìš© ê¸°ëŠ¥ê³¼ ëª¨ë¸ì„ êµ¬í˜„í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ ëœë‹¤. **ì• ê·¸ë¦¬ê±°íŠ¸ì˜ ì™„ì „í•œ ë¡œë”©ê³¼ ê´€ë ¨ëœ ë¬¸ì œëŠ” ìƒíƒœ ë³€ê²½ê³¼ ë” ê´€ë ¨ì´ ìˆë‹¤.**

<br>

ğŸ’â€â™‚ï¸ **ìœ„ì™€ ê°™ì´ ë¬¸ì œëŠ” ì§€ì—° ë¡œë”© ë°©ì‹ì„ í†µí•´ ìƒíƒœ ë³€ê²½ ì‹œì ì— í•„ìš”í•œ êµ¬ì„±ìš”ì†Œë§Œ ë¡œë”©í•´ì„œ ê°€ì ¸ì˜¨ë‹¤.**

~~~java
@Transactional
public void removeOptions(ProductId id, int optIdxBeDeleted) {
    // findById()ë¥¼ í†µí•´ Productë¥¼ ë¡œë”©í•  ë•Œ Optionì€ ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì— ë¡œë”©ë˜ì§€ ì•ŠìŒ 
    Product product = productRepository.findById(id);
    // íŠ¸ëœì­ì…˜ ë²”ìœ„ì´ë¯€ë¡œ ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•œ ì—°ê´€ ë¡œë”© ê°€ëŠ¥
    product.removeOption(optIdxToBeDeleted);
}

@Entity
public class Product {
    @ElmentCollection(fetch = FetchType.LAZY)
    @CollectionTable(name = "product_option",
            joinColumns = @JoinColumn(name = "product_id"))
    @OrderColumn(name = "list_idx")
    private List<Option> options = new ArrayList<>();

    public void removeOption(int optIdx) {
        // ì‹¤ì œ ì»¬ë ‰ì…˜ì— ì ‘ê·¼í•  ë•Œ ë¡œë”©
        this.options.remove(optIdx);
    }
}
~~~

- ì§€ì—° ë¡œë”©ì„ ì‚¬ìš©í•˜ë©´ ì¶”ê°€ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ëŠ” ë‹¨ì ì´ ìˆì§€ë§Œ, ìƒíƒœ ë³€ê²½ì„ ì‹¤í–‰í•˜ëŠ” ë¹ˆë„ê°€ ë†’ì§€ ì•Šì„ ê²½ìš° ì‹¤í–‰ ì†ë„ ì €í•˜ëŠ” ë³´í†µ ë¬¸ì œê°€ ë˜ì§€ ì•ŠëŠ”ë‹¤.

ğŸ’â€â™‚ï¸ ì§€ì—° ë¡œë”© ë°©ì‹ì˜ ë‹¨ì ë„ ì¡´ì¬í•˜ì§€ ë•Œë¬¸ì— ì• ê·¸ë¦¬ê±°íŠ¸ ì„±ê²©ì— ë§ê²Œ ì¦‰ì‹œ ë¡œë”©ê³¼ ì§€ì—° ë¡œë”©ì„ ì„ íƒí•´ì„œ êµ¬í˜„í•´ì•¼ í•œë‹¤.

<br>

# ì• ê·¸ë¦¬ê±°íŠ¸ì˜ ì˜ì†ì„± ì „íŒŒ

**ì• ê·¸ë¦¬ê±°íŠ¸ê°€ ì™„ì „í•œ ìƒíƒœì—¬ì•¼ í•œë‹¤ëŠ” ì˜ë¯¸ëŠ” ì €ì¥í•˜ê±°ë‚˜ ì‚­ì œí•  ë•Œë„ í•˜ë‚˜ë¡œ ì²˜ë¦¬í•´ì•¼í•¨ì„ ì˜ë¯¸**

- ì €ì¥ ë©”ì„œë“œëŠ” ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ë§Œ ì €ì¥í•˜ë©´ ì•ˆë˜ê³  ì• ê·¸ë¦¬ê±°íŠ¸ì— ì†í•œ ëª¨ë“  ê°ì²´ë¥¼ ì €ì¥í•´ì•¼ í•œë‹¤.
- ì‚­ì œ ë©”ì„œë“œëŠ” ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ë¿ë§Œ ì•„ë‹ˆë¼ ì• ê·¸ë¦¬ê±°íŠ¸ì— ì†í•œ ëª¨ë“  ê°ì²´ë¥¼ ì‚­ì œí•´ì•¼ í•œë‹¤.

<br>

@Entity íƒ€ì…ì— ëŒ€í•œ ë§¤í•‘ì€ cascade ì†ì„±ì„ ì‚¬ìš©í•´ì„œ ì €ì¥ ë˜ëŠ” ì‚­ì œ ì²˜ë¦¬ê°€ í•¨ê»˜ ë˜ë„ë¡ ì„¤ì •í•´ì•¼í•¨

~~~java
@OneToMany(cascade = {CascadeTYpe.PERSIST, CascadeType.REMOVE},
        orphanRemoval = true)
@JoinColum(name = "product_id")
@OrderColumn(name = "list_idx")
private List<Image> images = new ArrayList<>();
~~~

<br>

@Embeddable ë§¤í•‘ íƒ€ì…ì€ í•¨ê»˜ ì €ì¥, ì‚­ì œê°€ ë˜ë¯€ë¡œ ë”°ë¡œ ì„¤ì •í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

<br>

# ì‹ë³„ì ìƒì„± ê¸°ëŠ¥

**ì‹ë³„ì ì„¸ ê°€ì§€ ìƒì„± ë°©ì‹**

- ì‚¬ìš©ìê°€ ì§ì ‘ ìƒì„±
- ë„ë©”ì¸ ë¡œì§ìœ¼ë¡œ ìƒì„±
- DBë¥¼ ì´ìš©í•œ ì¼ë ¨ë²ˆí˜¸ ì‚¬ìš©

<br>

**ì‚¬ìš©ìê°€ ì§ì ‘ ìƒì„±**

ì´ë©”ì¼ ì£¼ì†Œì²˜ëŸ¼ ì‚¬ìš©ìê°€ ì§ì ‘ ì‹ë³„ìë¥¼ ì…ë ¥í•˜ëŠ” ê²½ìš°

> ì‚¬ìš©ìê°€ ì§ì ‘ ìƒì„±í•˜ëŠ” ë°©ì‹ì€ ì™¸ë¶€ì— ì˜ì¡´í•˜ê¸° ë•Œë¬¸ì— ì§€ì–‘í•´ì•¼ ëœë‹¤ê³  ìƒê°í•œë‹¤.
>
> ì´ë©”ì¼ ë“± ê°œì¸ ì •ë³´ë¥¼ ì‹ë³„ìë¡œ ì €ì¥í–ˆë‹¤ê°€ ì°¨í›„ì— ê°œì¸ ì •ë³´ ë™ì˜ê°€ í•„ìš”í•  ê²½ìš°ë§Œ ë°ì´í„°ë¥¼ ì €ì¥í•´ì•¼ ë˜ëŠ” ì •ì±…ì´ ìƒê¸¸ ê²½ìš° key ê°’ì„ ì¼ê´„ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ë³€ê²½í•´ì•¼ ë˜ëŠ” ìƒí™©ì´ ìƒê¸¸ ìˆ˜ë„ ìˆë‹¤.

<br>

**ë„ë©”ì¸ ë¡œì§ìœ¼ë¡œ ìƒì„±**

ìƒì„±ì ìƒì„± ê·œì¹™ì´ ìˆì„ ê²½ìš°, ë„ë©”ì¸ ê·œì¹™ì— í•´ë‹¹í•˜ë¯€ë¡œ ë„ë©”ì¸ ì˜ì—­ì— ì‹ë³„ì ìƒì„± ê¸°ëŠ¥ì„ êµ¬í˜„

~~~java
public class ProductIdService {
    public ProductId nextId() {
        // ì •í•´ì§„ ê·œì¹™ìœ¼ë¡œ ì‹ë³„ì ìƒì„±
    }
}
~~~

ë˜ëŠ” ë¦¬í¬ì§€í† ë¦¬ì— êµ¬í˜„

~~~java
public interface ProductRepository {
    ProductId nextId(); // êµ¬í˜„ í´ë˜ìŠ¤ì—ì„œ êµ¬í˜„
}
~~~

<br>

**DBë¥¼ ì´ìš©í•œ ì¼ë ¨ë²ˆí˜¸ ì‚¬ìš©**

DB ìë™ ì¦ê°€ ì»¬ëŸ¼ì„ ì‹ë³„ìë¡œ ì‚¬ìš©í•˜ë©´ ì‹ë³„ì ë§¤í•‘ì—ì„œ @GeneratedValueë¥¼ ì‚¬ìš©

~~~java
@Entity
@Table(name = "article")
public class Article {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    public Long getId() {
        return id;
    }
}
~~~

ğŸ‘‰ DBë¥¼ í†µí•œ ìë™ ì¦ê°€ë¥¼ ì‚¬ìš©í•˜ë©´ ì‹ë³„ìëŠ” ë¦¬í¬ì§€í† ë¦¬ì— ì €ì¥í•  ë•Œ ì‹ë³„ìê°€ ìƒì„±ëœë‹¤. ì¦‰, ê°ì²´ë¥¼ ì €ì¥ í›„ ì‹ë³„ìë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤.

-  JPAëŠ” ì €ì¥ ì‹œì ì— ìƒì„±í•œ ì‹ë³„ìë¥¼ @Idë¡œ ë§¤í•‘í•œ í”„ë¡œí¼í‹°/í•„ë“œì— í• ë‹¹

<br>

# ë„ë©”ì¸ êµ¬í˜„ê³¼ DIP

ğŸ‘‰ ì•„ë˜ì™€ ê°™ì´ ë„ë©”ì¸ ëª¨ë¸ ë° ë¦¬í¬ì§€í† ë¦¬ëŠ” DIP ì›ì¹™ì„ ì–´ê¸´ë‹¤.

**êµ¬í˜„ ê¸°ìˆ ì¸ JPAì— íŠ¹í™”ëœ ì–´ë…¸í…Œì´ì…˜(@Entity, @Table, @Id ë“±..)ì„ ì‚¬ìš©í•˜ëŠ” ë„ë©”ì¸ ëª¨ë¸**

~~~java
@Entity
@Table(name = "article")
public class Article {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
}
~~~

**êµ¬í˜„ ê¸°ìˆ ì¸ JPAì˜ Repository ì¸í„°í˜ì´ìŠ¤ ìƒì†í•˜ëŠ” ë¦¬í¬ì§€í† ë¦¬**

~~~java
import org.springframework.data.repository.Repository;

public interface ArticleRepository extends Repository<Article, Long> {
    void save(Article article);
    Optional<Article> findById(Long id);
}
~~~

<br>

### DIPë¥¼ ì ìš©í•˜ëŠ” ì£¼ëœ ì´ìœ 

ì €ìˆ˜ì¤€ êµ¬í˜„(êµ¬í˜„ ê¸°ìˆ )ì´ ë³€ê²½ë˜ë”ë¼ë„ ê³ ìˆ˜ì¤€ êµ¬í˜„ì´ ì˜í–¥ì„ ë°›ì§€ ì•Šë„ë¡ í•˜ê¸° ìœ„í•¨

ğŸ’â€â™‚ï¸ **êµ¬í˜„ ê¸°ìˆ ì— ì˜ì¡´ ì—†ì´ ë„ë©”ì¸ì„ ìˆœìˆ˜í•˜ê²Œ ìœ ì§€í•˜ë ¤ë©´ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ì¸í”„ë¼ì— ìœ„ì¹˜ì‹œí‚¤ê³  êµ¬í˜„ ê¸°ìˆ ê³¼ ì—°ë™í•˜ê¸° ìœ„í•œ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•´ì•¼ í•œë‹¤.**

<br>

ğŸ¤” **ë§Œì•½ êµ¬í˜„ ê¸°ìˆ ì´ ê±°ì˜ ë°”ë€” ì¼ì´ ì—†ë‹¤ë©´ êµ³ì´ DIPë¥¼ ì ìš©í•´ì•¼í• ê¹Œ?**

- ë³€ê²½ì´ ê±°ì˜ ì—†ëŠ” ìƒí™©ì— ë³€ê²½ì„ ë¯¸ë¦¬ ëŒ€ë¹„í•˜ëŠ” ê±´ ê³¼í•  ìˆ˜ ìˆë‹¤.
- í•˜ì§€ë§Œ DIPë¥¼ ì™„ë²½í•˜ê²Œ ì§€ì¼œì£¼ë©´ ìœ„ì™€ ê°™ì€ ì¥ì ì„ ëˆ„ë¦´ ìˆ˜ ìˆì§€ë§Œ êµ¬ì¡°ì ì¸ ìœ ì—°í•¨ì€ ì–´ëŠ ì •ë„ ìœ ì§€í•˜ëŠ” ì„ ìœ¼ë¡œ íƒ€í˜‘ì„ í•˜ê²Œ ëœë‹¤ë©´ ê°œë°œ í¸ì˜ì„± ë° ì‹¤ìš©ì„±ì„ ê°€ì ¸ê°ˆ ìˆ˜ ìˆë‹¤.
- ë³µì¡ë„ë¥¼ ë†’ì´ì§€ ì•Šìœ¼ë©´ì„œ ê¸°ìˆ ì— ë”°ë¥¸ êµ¬í˜„ ì œì•½ì´ ë‚®ë‹¤ë©´ í•©ë¦¬ì ì¸ ì„ íƒì´ ë  ìˆ˜ ìˆë‹¤.
