# JPAë¥¼ ì´ìš©í•œ ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„

ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ëŠ” ì• ê·¸ë¦¬ê±°íŠ¸ì™€ ê°™ì€ ë„ë©”ì¸ ì˜ì—­ì— ì†í•˜ê³ , ë¦¬í¬ì§€í† ë¦¬ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ëŠ” ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ì˜ì—­ì— ì†í•œë‹¤.

<p align="center"><img width="700" alt="ìŠ¤í¬ë¦°ìƒ· 2023-06-25 ì˜¤í›„ 11 07 06" src="https://github.com/b2aconnn/TIL/assets/89119477/0d9c4110-d6a8-4e1f-93b3-af7db648231c"></p>

<p align="center">DIP ì ìš©í•  ê²½ìš° êµ¬í˜„ í´ë˜ìŠ¤ëŠ” ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì³ ì˜ì—­ì— ìœ„ì¹˜</p>

<br>

## ë¦¬í¬ì§€í† ë¦¬ ê¸°ë³¸ ê¸°ëŠ¥ êµ¬í˜„

- IDë¥¼ í†µí•œ ì• ê·¸ë¦¬ê±°íŠ¸ ì¡°íšŒ
- ì• ê·¸ë¦¬ê±°íŠ¸ ì €ì¥

<br>

**ë‘ ê¸°ëŠ¥ì„ ì¸í„°í˜ì´ìŠ¤ë¡œ í‘œí˜„**

~~~java
public interface OrderRepository {
    Order findById(OrderNo no);
    void save(Order order);
}
~~~

ì¸í„°í˜ì´ìŠ¤ëŠ” ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ì„ í•œë‹¤. 

ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ì˜ ì´ë¦„ì„ ì§€ì„ ë•ŒëŠ” ë³´í†µ findByí”„ë¡œí¼í‹°ì´ë¦„(í”„ë¡œí¼í‹° ê°’) í˜•ì‹ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.

<br>

**ìœ„ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ JPAì˜ EntityManagerë¡œ êµ¬í˜„í•œ í´ë˜ìŠ¤**

~~~java
@Repository
class JpaOrderRepository implements OrderRepository {
    @PersistenceContext
    private EntityManager entityManager;

    @Override
    public Order findById(OrderNo id) {
        // Idë¥¼ í†µí•´ ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ì¡°íšŒ
        return entityManager.find(Order.class, id);
    }

    @Override
    public void save(Order order) {
        // ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ì €ì¥
        entityManager.persist(order);
    }
}
~~~

<br>

**ì• ê·¸ë¦¬ê±°íŠ¸ì˜ ìˆ˜ì •**

~~~java
public class ChangeOrderService {
    @Transactional
    public void changeShippingInfo(OrderNo no, ShippingInfo newShippingInfo) {
        Optional<Order> orderOpt = orderRepository.findById(no);
        Order order = orderOpt.orElseThrow(() -> new OrderNotFoundException());
        // ì• ê·¸ë¦¬ê±°íŠ¸ ìˆ˜ì •
        order.changeShippingInfo(newShippingInfo);
    }
}
~~~

**ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ìˆ˜ì •í•œ í›„ì— ì €ì¥ì†Œì— ë°˜ì˜í•˜ëŠ” ë©”ì†Œë“œë¥¼ ë”°ë¡œ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ë‹¤.**

JPAë¥¼ ì‚¬ìš©í•˜ë©´ íŠ¸ë™ì­ì…˜ ë²”ìœ„ì—ì„œ ë³€ê²½í•œ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ UPDATE ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ì—¬ DBì— ë°˜ì˜ì„ í•´ì£¼ê¸° ë•Œë¬¸ì´ë‹¤.

<br>

**ì• ê·¸ë¦¬ê±°íŠ¸ ì¡°íšŒ**

~~~java
public interface OrderRepository {
    List<Order> findByOrdererId(String ordererId, int startRow, int size);
}
~~~

JPAì—ì„œ ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ì¡°íšŒí•  ë•ŒëŠ” findByë’¤ì— ì¡°ê±´ ëŒ€ìƒì´ ë˜ëŠ” í”„ë¡œí¼í‹°ëª…ì„ ë¶™ì´ë©´ ëœë‹¤.

ë˜ JPAì˜ Criteriaë‚˜ JPQL, queryDSL ë“±ìœ¼ë¡œ ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.

<br>

**ì• ê·¸ë¦¬ê±°íŠ¸ ì‚­ì œ**

~~~java
public interface OrderRepository {
    public void delete(Order order);
}
~~~

ì‚­ì œí•  ì• ê·¸ë¦¬ê±°íŠ¸ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•˜ë©´ ëœë‹¤.

â—ï¸ë³´í†µì€ ì‹¤ì œë¡œ ë¬¼ë¦¬ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì‚­ì œ(hardDelete)í•˜ì§€ ì•ŠëŠ”ë‹¤. ë°ì´í„° ì›ë³µì´ë‚˜ ì¼ì • ê¸°ê°„ ë™ì•ˆ ë°ì´í„°ë¥¼ ë³´ê´€í•´ì•¼ í•  ë•Œë„ ìˆê¸° ë•Œë¬¸ì— ë³´í†µì€ ë…¼ë¦¬ì ì¸ ì‚­ì œ(softDelete)ë¥¼ í†µí•´ ê´€ë¦¬ë¥¼ í•œë‹¤.

<br>

# ë§¤í•‘ êµ¬í˜„

## ì—”í‹°í‹°ì™€ ë°¸ë¥˜ ê¸°ë³¸ ë§¤í•‘ êµ¬í˜„

**ì• ê·¸ë¦¬ê±°íŠ¸ì™€ JPA ë§¤í•‘ì„ ìœ„í•œ ê¸°ë³¸ ê·œì¹™**

- ì• ê·¸ë¦¬ê±°íŠ¸ ë£¨íŠ¸ëŠ” ì—”í‹°í‹°ì´ë¯€ë¡œ @Entityë¡œ ë§¤í•‘ ì„¤ì •

**í•œ í…Œì´ë¸”ì— ì—”í‹°í‹°ì™€ ë°¸ë¥˜ê°€ ê°™ì´ ìˆë‹¤ë©´?**

- ë°¸ë¥˜ëŠ” @Embeddableë¡œ ë§¤í•‘ ì„¤ì •
- ë°¸ë¥˜ íƒ€ì… í”„ë¡œí¼í‹°ëŠ” @Embeddedë¡œ ë§¤í•‘ ì„¤ì •

<br>

ğŸ‘‰ ì£¼ë¬¸ ì• ê·¸ë¦¬ê±°íŠ¸ì˜ ì˜ˆ

- ë£¨íŠ¸ ì—”í‹°í‹° : Order
- ë°¸ë¥˜ : Orderer, ShippingInfo, Address, Receiver

<p align="center"><img width="700" alt="ìŠ¤í¬ë¦°ìƒ· 2023-07-10 ì˜¤í›„ 11 54 43" src="https://github.com/b2aconnn/TIL/assets/89119477/1e7c3455-ca80-4181-84cc-81a18a84b22e"></p>

<br>

### JPAì™€ ë§¤í•‘

ë£¨íŠ¸ ì—”í‹°í‹°ì¸ OrderëŠ” JPAì˜ @Entityë¡œ ë§¤í•‘

~~~java
@Entity
@Table(name = "purchase_order")
public class Order {
    // ...
}
~~~

<br>

Orderì— ì†í•˜ëŠ” OrdererëŠ” ë°¸ë¥˜ì´ë¯€ë¡œ @Embeddableë¡œ ë§¤í•‘

~~~java
@Embeddable
public class Orderer {
    // MemberIdì— ì •ì˜ëœ ì»¬ëŸ¼ ì´ë¦„ì„ ë³€ê²½í•˜ê¸° ìœ„í•´ @AttributeOverride ì‚¬ìš©
    @Embedded
    @AttributeOverrides(
        @AttributeOverride(name = "id", column = @Column(name = "orderer_id"))
    )
    private MemberId memberId;

    @Column(name = "orderer_name")
    private String name;
}

@Embeddable
public class MemberId implements Serializable {
    @Column(name = "member_id")
    private String id;
}
~~~

<br>

ë£¨íŠ¸ ì—”í‹°í‹° Order í´ë˜ìŠ¤ëŠ” @Embeddedë¥¼ ì„ ì–¸í•´ ë°¸ë¥˜ íƒ€ì… í”„ë¡œí¼í‹°ë¥¼ ì„¤ì •

~~~java
@Entity
public class Order {
    @Embedded
    private Orderer orderer;
    @Embedded
    private ShippingInfo shippingInfo;
}
~~~

<br>

## ê¸°ë³¸ ìƒì„±ì

**ReceiverëŠ” ë°¸ë¥˜ì´ê³ , ë¶ˆë³€ íƒ€ì…ìœ¼ë¡œ ë§Œë“¤ë ¤ë©´ ìƒì„± ì‹œì ì— í•„ìš”í•œ ê°’ë“¤ì„ ìƒì„±ìë¥¼ í†µí•´ ëª¨ë‘ ì „ë‹¬ ë°›ìœ¼ë¯€ë¡œ set ë©”ì„œë“œë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤. ì¦‰, ê¸°ë³¸ ìƒì„±ìëŠ” í•„ìš” ì—†ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸**í•œë‹¤.

<br>

â—ï¸í•˜ì§€ë§Œ JPAì—ì„œ @Entityì™€ @Embeddableë¡œ í´ë˜ìŠ¤ë¥¼ ë§¤í•‘í•˜ë ¤ë©´ ê¸°ë³¸ ìƒì„±ìê°€ í•„ìš”í•¨

- DBì—ì„œ ë°ì´í„°ë¥¼ ì½ì–´ì™€ì„œ ë§¤í•‘ëœ ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ ê¸°ë³¸ ìƒì„±ìë¥¼ ì‚¬ìš©í•´ì„œ ê°ì²´ë¥¼ ìƒì„±í•˜ê¸° ë•Œë¬¸

<br>

ì´ëŸ° ê¸°ìˆ ì ì¸ ì œì•½ìœ¼ë¡œ ì¸í•´ Receiverì™€ ê°™ì€ ë¶ˆë³€ íƒ•ë¹„ì€ ê¸°ë³¸ ìƒì„±ìê°€ í•„ìš” ì—†ìŒì—ë„ ê¸°ë³¸ ìƒì„±ìë¥¼ ì¶”ê°€í•´ì•¼ í•œë‹¤. ğŸ˜¢

~~~java
@Embeddable
public class Receiver {
    @Column(name = "receiver_name")
    private String name;
    @Column(name = "receiver_phone")
    private String phone;

    protected Receiver() {} // JPAë¥¼ ì ìš©í•˜ê¸° ìœ„í•œ ê¸°ë³¸ ìƒì„±ì ì¶”ê°€

    public Receiver(String name, String phone) {
        this.name = name;
        this.phone = phone;
    }
}
~~~

**ê¸°ë³¸ ìƒì„±ìëŠ” JPA Providerê°€ ê°ì²´ë¥¼ ìƒì„±í•  ë•Œë§Œ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ ì½”ë“œì—ì„œëŠ” ê¸°ë³¸ ìƒì„±ìë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•˜ë„ë¡ protected ì ‘ê·¼ ì œí•œìë¥¼ í†µí•´ ì œí•œí•œë‹¤.**

<br>

## í•„ë“œ ì ‘ê·¼ ë°©ì‹ ì‚¬ìš©

JPAëŠ” í•„ë“œì™€ ë©”ì„œë“œ ë‘ ê°€ì§€ ë°©ì‹ìœ¼ë¡œ ë§¤í•‘ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

- ë©”ì„œë“œ ë°©ì‹ : í”„ë¡œí¼í‹°ë¥¼ ìœ„í•œ get/set ë©”ì„œë“œë¥¼ êµ¬í˜„

~~~java
@Entity
@Access(AccessType.PROPERTY)
public class Order {
    @Column(name = "state")
    @Enumerated(EnumType.STRING)
    public OrderState getState() {
        return state;
    }
    
    public setState(OrderState state) {
        this.state = state;
    }
}
~~~

â—ï¸ ìœ„ì™€ ê°™ì´ ë©”ì„œë“œ ë°©ì‹ì„ í†µí•´ í”„ë¡œí¼í‹°ë¥¼ ìœ„í•œ set ë©”ì„œë“œë¥¼ ë§Œë“¤ê²Œ ë˜ë©´ ë‚´ë¶€ ë°ì´í„°ë¥¼ ì™¸ë¶€ì—ì„œ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ê°€ëŠ¥ì„±ì„ ì—´ì–´ë‘ê¸° ë•Œë¬¸ì— ìº¡ìŠí™”ë¥¼ ê¹¨ëŠ” ì›ì¸ì´ ë˜ì–´ ê°ì²´ë¡œì„œ ì œ ì—­í• ì„ í•˜ì§€ ëª» í•  ìˆ˜ ìˆë‹¤.

<br>

- í•„ë“œ ë°©ì‹

~~~java
@Entity
@Access(AccessType.FIELD)
public class Order {
    @EmbeddedId
    private OrderNo number;

    @Column(name = "state")
    @Enumerated(EnumType.STRING)
    private OrderState state;
    
    public void cancel() { // ëª…í™•í•œ ì˜ë„ë¡œ ë„ë©”ì¸ ê¸°ëŠ¥ êµ¬í˜„
        // ...
    }
}
~~~

set ë©”ì„œë“œ ëŒ€ì‹  ëª…í™•í•œ ì˜ë„ê°€ ë“œëŸ¬ë‚˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•˜ë¯€ë¡œì¨ ë„ë©”ì¸ì„ ë” ì˜ í‘œí˜„í•  ìˆ˜ ìˆë‹¤.
